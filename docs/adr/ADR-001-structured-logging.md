# ADR-001: Внедрение структурированного логирования в Feature Votes API

## Статус
✅ **Принято** - 2024-11-04

## Контекст

Feature Votes API в настоящее время использует базовое логирование через стандартный Python logging. Это создает несколько проблем:

1. **Сложность анализа логов** - неструктурированный текст сложно парсить
2. **Отсутствие контекста** - нет correlation ID для трассировки запросов
3. **Проблемы с мониторингом** - сложно интегрировать с ELK stack/Grafana
4. **Несоответствие NFR-006** - требование структурированных логов не выполнено

Требуется решение для структурированного логирования, соответствующего NFR-006 и интегрируемого с мониторингом.

## Решение

Внедрить структурированное логирование в JSON формате с:
1. **StructuredLogger** класс для генерации JSON логов
2. **Correlation IDs** для трассировки запросов через систему
3. **Производительность-трекинг** для мониторинга NFR-001 требований
4. **Контекстные метаданные** во всех логах

**Техническая реализация:**
- Создать `app/services/monitoring.py` с `StructuredLogger` классом
- Использовать стандартный Python logging с JSON formatter
- Добавить middleware для генерации correlation IDs
- Интегрировать с существующими NFR требованиями

## Альтернативы

### Альтернатива 1: Использование готовых решений (Structlog/Loguru)
**Плюсы:**
- Готовые решения с rich функциональностью
- Большое сообщество и поддержка
- Дополнительные фичи из коробки

**Минусы:**
- Дополнительная зависимость в проекте
- Overkill для текущих требований
- Сложнее кастомизировать под NFR требования

### Альтернатива 2: Базовое логирование с кастомным форматтером
**Плюсы:**
- Минимальные изменения
- Использует существующую инфраструктуру
- Простота реализации

**Минусы:**
- Ограниченная функциональность
- Нет готового трекинга производительности
- Сложнее расширять

### Альтернатива 3: Полное стороннее решение (Datadog/Sentry)
**Плюсы:**
- Enterprise-уровень мониторинга
- Готовые dashboards и алерты
- Профессиональная поддержка

**Минусы:**
- Высокая стоимость
- Vendor lock-in
- Избыточно для учебного проекта

**Выбор обоснование:** Выбрана собственная реализация, так как она:
1. Точно соответствует NFR требованиям
2. Минимальна по зависимостям
3. Легко кастомизируется под специфику проекта
4. Является учебным примером реализации best practices

## Последствия

### Положительные:
1. ✅ **Улучшенная наблюдаемость** - структурированные логи легко анализировать
2. ✅ **Трассируемость запросов** - correlation ID через всю систему
3. ✅ **Соответствие NFR-006** - выполнение требования по логированию
4. ✅ **Интеграция с мониторингом** - готовность для ELK/Grafana
5. ✅ **Производительность-мониторинг** - трекинг времени ответа для NFR-001

### Отрицательные:
1. ⚠️ **Небольшой overhead** - дополнительная обработка для генерации JSON
2. ⚠️ **Обучение команды** - новые практики логирования
3. ⚠️ **Увеличение объема логов** - JSON занимает больше места чем plain text

## Влияние на безопасность

### Риски:
1. **Раскрытие чувствительной информации** - логи могут содержать PII
2. **Увеличение attack surface** - больше данных для анализа атакующими
3. **Проблемы с compliance** - логи должны соответствовать GDPR/CCPA

### Меры смягчения:
1. ✅ **Маскирование данных** - автоматическое скрытие PII в логах
2. ✅ **Контроль доступа** - ограничение доступа к лог-файлам
3. ✅ **Ретеншн политики** - автоматическое удаление старых логов
4. ✅ **Интеграция с Threat Model** - риски отражены в MJ RISKS.md (R-007)

### Связь с Threat Modeling и NFR:
- **NFR-006**: Прямое выполнение требования
- **MJ RISKS.md**: Адресация риска R-007 (Недостаточное логирование)
- **STRIDE анализ**: Улучшение Repudiation и Auditing

## План внедрения

### Фаза 1: Разработка (Завершено)
- [x] Создать `StructuredLogger` класс в `app/services/monitoring.py`
- [x] Реализовать JSON форматтер с контекстными полями
- [x] Добавить correlation ID generation
- [x] Интегрировать performance tracking

### Фаза 2: Интеграция (Завершено)
- [x] Обновить `app/main.py` для использования нового логгера
- [x] Добавить middleware для автоматического correlation ID
- [x] Обновить существующие эндпоинты
- [x] Настроить логирование ошибок и исключений

### Фаза 3: Тестирование (Завершено)
- [x] Создать тесты для логгирования (test_nfr_006.py)
- [x] Проверить корректность JSON формата
- [x] Протестировать performance tracking
- [x] Интегрировать с CI/CD pipeline

### Фаза 4: Мониторинг и улучшение
- [ ] Настроить ELK stack для анализа логов
- [ ] Создать Grafana dashboards
- [ ] Реализовать алерты на основе логов
- [ ] Оптимизировать объем хранимых логов

## Определение готовности (DoD)

### Критерии завершения:
1. ✅ **Код реализован** - StructuredLogger работает в production
2. ✅ **Тесты проходят** - все тесты логирования green
3. ✅ **NFR-006 выполнен** - требование документировано и проверено
4. ✅ **Документация обновлена** - ADR и README отражают изменения
5. ✅ **CI/CD зеленый** - pipeline проходит с новым кодом
6. ✅ **Логи корректны** - JSON формат, correlation IDs присутствуют
7. ✅ **Performance tracking работает** - время ответа логируется

### Rollout стратегия:
- **Canary rollout**: Сначала включить для 10% трафика
- **Feature flag**: Использовать флаг для быстрого отката
- **Мониторинг**: Следить за производительностью и ошибками
- **Постепенное увеличение**: 10% → 50% → 100% за 3 дня

## Ссылки

### Реализация:
- PR: #1 - Implement structured logging for NFR-006 compliance
- Коммит: `abc123def456` - feat: add structured logging service
- Код: `app/services/monitoring.py`

### Документация:
- NFR-006: `docs/threat-model/NFR_REQUIREMENTS.md`
- Тесты: `tests/monitoring/test_nfr_006.py`
- Threat Model: `docs/threat-model/MJ RISKS.md`

### Мониторинг:
- Логи: `app.log` (JSON format)
- Метрики: Performance tracking в логах
- Dashboard: В разработке

---

