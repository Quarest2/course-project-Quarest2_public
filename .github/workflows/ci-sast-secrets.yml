name: Security - SAST & Secrets

on:
  push:
    branches: [ main, develop ]
    paths:
      - "**/*.py"
      - "**/*.js"
      - "**/*.ts"
      - "**/*.yaml"
      - "**/*.yml"
      - "**/*.json"
      - "**/*.toml"
      - "**/Dockerfile"
      - "security/**"
      - ".github/workflows/ci-sast-secrets.yml"
  pull_request:
    branches: [ main, develop ]
    paths:
      - "**/*.py"
      - "**/*.js"
      - "**/*.ts"
      - "**/*.yaml"
      - "**/*.yml"
      - "**/*.json"
      - "**/*.toml"
      - "**/Dockerfile"
      - "security/**"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

concurrency:
  group: sast-secrets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast:
    name: Run SAST (Semgrep)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create evidence directory
        run: mkdir -p EVIDENCE/P10

      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: >
            p/ci
            security/semgrep/rules.yml
          output: EVIDENCE/P10/semgrep.sarif
          publish-token: ${{ secrets.GITHUB_TOKEN }}
          publish-deployment: false
          metrics: off

      - name: Generate SAST summary
        run: |
          python3 << 'EOF'
          import json, os, sys
          
          sarif_file = "EVIDENCE/P10/semgrep.sarif"
          summary_file = "EVIDENCE/P10/sast_summary.md"
          
          try:
              with open(sarif_file, 'r') as f:
                  data = json.load(f)
              
              findings = []
              for run in data.get('runs', []):
                  for result in run.get('results', []):
                      severity = result.get('level', 'warning')
                      rule_id = result.get('ruleId', 'unknown')
                      message = result.get('message', {}).get('text', '')
                      location = result.get('locations', [{}])[0].get('physicalLocation', {}).get('artifactLocation', {}).get('uri', '')
                      findings.append({
                          'severity': severity,
                          'rule': rule_id,
                          'message': message[:200],
                          'file': location
                      })
              
              # Group by severity
              counts = {}
              for f in findings:
                  counts[f['severity']] = counts.get(f['severity'], 0) + 1
              
              # Write summary
              with open(summary_file, 'w') as f:
                  f.write("# SAST Summary (P10)\n\n")
                  f.write("## Statistics\n")
                  for severity in ['error', 'warning', 'note']:
                      count = counts.get(severity, 0)
                      f.write(f"- **{severity.upper()}**: {count}\n")
                  
                  f.write(f"\n**Total findings**: {len(findings)}\n\n")
                  
                  if findings:
                      f.write("## Key Findings\n")
                      for finding in findings[:5]:  # Top 5
                          f.write(f"### {finding['rule']} ({finding['severity']})\n")
                          f.write(f"- File: {finding['file']}\n")
                          f.write(f"- Message: {finding['message']}\n\n")
                      
                      if len(findings) > 5:
                          f.write(f"*... and {len(findings) - 5} more findings*\n")
                  
                  f.write("\n---\n")
                  f.write("*Generated by Semgrep CI Scan*")
              
              print(f"SAST summary written to {summary_file}")
              print(f"Findings: {len(findings)}")
              
          except Exception as e:
              print(f"Error generating summary: {e}")
              # Create empty summary
              with open(summary_file, 'w') as f:
                  f.write("# SAST Summary\n\nNo findings or error processing report.\n")
          EOF

      - name: Upload SAST artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast-${{ github.run_id }}
          path: |
            EVIDENCE/P10/semgrep.sarif
            EVIDENCE/P10/sast_summary.md
          retention-days: 30

  secrets:
    name: Scan for Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create evidence directory
        run: mkdir -p EVIDENCE/P10

      - name: Run Gitleaks
        run: |
          docker run --rm \
            -v "$PWD:/repo" \
            -v "$PWD/security/.gitleaks.toml:/repo/.gitleaks.toml" \
            zricethezav/gitleaks:latest \
            detect --no-banner \
            --config=/repo/.gitleaks.toml \
            --source=/repo \
            --report-format=json \
            --report-path=/repo/EVIDENCE/P10/gitleaks.json \
            --verbose || true

      - name: Generate Secrets summary
        run: |
          python3 << 'EOF'
          import json, os
          
          gitleaks_file = "EVIDENCE/P10/gitleaks.json"
          summary_file = "EVIDENCE/P10/secrets_summary.md"
          
          try:
              with open(gitleaks_file, 'r') as f:
                  data = json.load(f)
              
              findings = data if isinstance(data, list) else []
              
              with open(summary_file, 'w') as f:
                  f.write("# Secrets Scan Summary (P10)\n\n")
                  f.write(f"## Statistics\n")
                  f.write(f"- **Total findings**: {len(findings)}\n\n")
                  
                  if findings:
                      f.write("## Findings by Type\n")
                      types = {}
                      for finding in findings:
                          rule_id = finding.get('RuleID', 'unknown')
                          types[rule_id] = types.get(rule_id, 0) + 1
                      
                      for rule_id, count in sorted(types.items()):
                          f.write(f"- **{rule_id}**: {count}\n")
                      
                      f.write("\n## Sample Findings\n")
                      for finding in findings[:3]:
                          f.write(f"### {finding.get('RuleID', 'N/A')}\n")
                          f.write(f"- File: {finding.get('File', 'N/A')}\n")
                          f.write(f"- Line: {finding.get('StartLine', 'N/A')}\n")
                          f.write(f"- Secret: {finding.get('Secret', 'N/A')[:50]}...\n\n")
                      
                      if len(findings) > 3:
                          f.write(f"*... and {len(findings) - 3} more findings*\n")
                  else:
                      f.write("âœ… No secrets found.\n")
                  
                  f.write("\n---\n")
                  f.write("*Generated by Gitleaks CI Scan*")
              
              print(f"Secrets summary written to {summary_file}")
              
          except Exception as e:
              print(f"Error generating summary: {e}")
              with open(summary_file, 'w') as f:
                  f.write("# Secrets Scan Summary\n\nError processing report.\n")
          EOF

      - name: Upload Secrets artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secrets-${{ github.run_id }}
          path: |
            EVIDENCE/P10/gitleaks.json
            EVIDENCE/P10/secrets_summary.md
          retention-days: 30

  evidence-readme:
    name: Generate Evidence README
    runs-on: ubuntu-latest
    needs: [sast, secrets]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate P10 README
        run: |
          cat > EVIDENCE/P10/README.md << 'EOF'
          # P10 - SAST & Secrets Analysis
          
          ## Files:
          
          1. **semgrep.sarif** - SAST findings from Semgrep
          2. **sast_summary.md** - Human-readable SAST summary
          3. **gitleaks.json** - Secrets detection results
          4. **secrets_summary.md** - Secrets scan summary
          
          ## Usage in DS2 (Static Analysis Section):
          
          Use these reports for:
          - Code quality and security issues analysis
          - Secrets exposure risk assessment
          - Technical debt tracking
          
          ## Tools:
          - **Semgrep**: Static Application Security Testing
          - **Gitleaks**: Secrets detection in code
          
          ## Update Frequency:
          - Runs on code changes to main/develop
          - Manual trigger via workflow_dispatch
          
          EOF

      - name: Upload Evidence README
        uses: actions/upload-artifact@v4
        with:
          name: p10-readme
          path: EVIDENCE/P10/README.md
          retention-days: 30