name: P12 - IaC & Container Security

on:
  push:
    branches: [main, develop]
    paths:
      - "Dockerfile"
      - "compose.yaml"
      - "iac/**"
      - "security/**"
      - ".github/workflows/ci-p12-iac-container.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "Dockerfile"
      - "compose.yaml"
      - "iac/**"
      - "security/**"
  workflow_dispatch:

concurrency:
  group: p12-security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  hadolint:
    name: Hadolint - Dockerfile Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        id: hadolint
        continue-on-error: true
        run: |
          docker run --rm -i \
            -v "${{ github.workspace }}":/workspace \
            -w /workspace \
            hadolint/hadolint:v2.12.0 \
            hadolint \
            --config /workspace/security/hadolint.yaml \
            --format json \
            /workspace/Dockerfile > hadolint-output.json 2>&1 || true
          mkdir -p EVIDENCE/P12
          if [ -f hadolint-output.json ] && [ -s hadolint-output.json ]; then
            mv hadolint-output.json EVIDENCE/P12/hadolint_report.json
          else
            echo '[]' > EVIDENCE/P12/hadolint_report.json
          fi

      - name: Upload Hadolint report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hadolint-report-${{ github.run_id }}
          path: EVIDENCE/P12/hadolint_report.json
          retention-days: 30

  checkov:
    name: Checkov - IaC Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Checkov output directory
        run: |
          mkdir -p EVIDENCE/P12
          rm -rf EVIDENCE/P12/checkov_report.json

      - name: Run Checkov on Dockerfile and Compose
        id: checkov_scan
        uses: bridgecrewio/checkov-action@master
        continue-on-error: true
        with:
          directory: .
          framework: dockerfile
          output_format: json
          output_file_path: EVIDENCE/P12/checkov_report.json
          config_file: security/checkov.yaml
          soft_fail: true
          quiet: true

      - name: Ensure Checkov report exists
        if: always()
        run: |
          mkdir -p EVIDENCE/P12
          if [ -d EVIDENCE/P12/checkov_report.json ]; then
            sudo mv EVIDENCE/P12/checkov_report.json/results_json.json EVIDENCE/P12/checkov_report.tmp || true
            sudo rm -rf EVIDENCE/P12/checkov_report.json || true
            sudo mv EVIDENCE/P12/checkov_report.tmp EVIDENCE/P12/checkov_report.json || true
          fi
          if [ ! -f EVIDENCE/P12/checkov_report.json ]; then
            echo '{"summary": {"passed": 0, "failed": 0, "skipped": 0, "parsing_errors": 0}, "results": {"passed_checks": [], "failed_checks": [], "skipped_checks": []}}' > EVIDENCE/P12/checkov_report.json
          fi

      - name: Upload Checkov report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-report-${{ github.run_id }}
          path: EVIDENCE/P12/checkov_report.json
          retention-days: 30

  trivy:
    name: Trivy - Container Image Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: []
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: feature-api:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: feature-api:test
          format: json
          output: EVIDENCE/P12/trivy_report.json
          severity: CRITICAL,HIGH,MEDIUM,LOW
          exit-code: 0
          ignore-unfixed: false

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report-${{ github.run_id }}
          path: EVIDENCE/P12/trivy_report.json
          retention-days: 30

      - name: Generate Trivy summary
        if: always()
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path

          report_path = Path("EVIDENCE/P12/trivy_report.json")
          if not report_path.exists():
              print("Trivy report not found")
              exit(0)

          with open(report_path) as f:
              data = json.load(f)

          results = data.get("Results", [])
          total_vulns = 0
          by_severity = {"CRITICAL": 0, "HIGH": 0, "MEDIUM": 0, "LOW": 0}

          for result in results:
              vulns = result.get("Vulnerabilities", [])
              for vuln in vulns:
                  severity = vuln.get("Severity", "UNKNOWN")
                  if severity in by_severity:
                      by_severity[severity] += 1
                      total_vulns += 1

          print("## Trivy Scan Summary")
          print(f"Total vulnerabilities: {total_vulns}")
          for sev in ["CRITICAL", "HIGH", "MEDIUM", "LOW"]:
              print(f"- {sev}: {by_severity[sev]}")
          EOF

  summary:
    name: P12 Security Summary
    runs-on: ubuntu-latest
    needs: [hadolint, checkov, trivy]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-report-*"
          merge-multiple: false

      - name: Generate summary
        run: |
          echo "## P12 Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Hadolint (Dockerfile)" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.hadolint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checkov (IaC)" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.checkov.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trivy (Container Image)" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.trivy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
